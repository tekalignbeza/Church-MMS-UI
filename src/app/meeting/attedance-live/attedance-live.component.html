<!-- Scanner Flag Overlay -->
<div class="scanner-container">
  <div *ngIf="currentFlag" class="flag-container" [ngClass]="currentFlag">
    <div class="flag">{{ currentFlag.toUpperCase() }}</div>
  </div>
</div>

<div class="church-attendance-page">
  <div class="church-grid church-grid-cols-1">
    <!-- Search Section -->
    <div class="church-section">
      <div class="church-section-header">
        <h2 class="church-section-title">Live Attendance - Barcode Scanner</h2>
      </div>
      <div class="church-section-content">
        <form class="church-form">
          <div class="church-search-grid">
            <div class="church-form-group">
              <mat-form-field appearance="outline">
                <input matInput placeholder="Meeting Title" [(ngModel)]="meetingTitle" disabled="true">
              </mat-form-field>
            </div>
            <div class="church-form-group">
              <mat-form-field appearance="outline">
                <input matInput placeholder="Meeting Contact" disabled="true">
              </mat-form-field>
            </div>
            <div class="church-form-group" *ngIf="!isCameraEnabled">
              <mat-form-field appearance="outline">
                <input #barcodeInput
                       matInput
                       type="text"
                       placeholder="Scan member's barcode or Enter Member ID"
                       (keydown.enter)="onScan(barcodeInput.value)"
                       autocomplete="off">
                <mat-icon matSuffix>qr_code_scanner</mat-icon>
              </mat-form-field>
            </div>
            
            <!-- Camera Scanner in same grid position -->
            <div class="church-form-group scanner-grid-item" *ngIf="isCameraEnabled">
              <div class="inline-scanner-container">
                <zxing-scanner 
                  #scanner
                  [enable]="isCameraEnabled"
                  [device]="selectedDevice"
                  (scanSuccess)="onCameraScan($event)"
                  (scanError)="onScanError($event)"
                  (scanFailure)="onScanFailure($event)"
                  (scanComplete)="onScanComplete($event)"
                  [formats]="allowedFormats">
                </zxing-scanner>
              </div>
            </div>
          </div>
          <div class="church-form-actions">
            <button class="church-btn church-btn-primary" type="button" (click)="onManualSearch()" *ngIf="!isCameraEnabled">Search by ID</button>
            <button class="church-btn church-btn-secondary" type="button" (click)="toggleCamera()" [disabled]="!hasDevices">
              <mat-icon>{{ isCameraEnabled ? 'videocam_off' : 'videocam' }}</mat-icon>
              {{ isCameraEnabled ? 'Stop Camera' : 'Start Camera' }}
            </button>
            <button class="church-btn church-btn-outline" type="button" (click)="onReset()">Reset</button>
          </div>
        </form>
        
        <!-- Camera Controls (if multiple cameras available) -->
        <div class="scanner-controls" *ngIf="isCameraEnabled && availableDevices && availableDevices.length > 1">
          <mat-form-field appearance="outline">
            <mat-label>Camera</mat-label>
            <mat-select [(value)]="selectedDevice" (selectionChange)="onCameraChange($event.value)">
              <mat-option *ngFor="let device of availableDevices" [value]="device">
                {{ device.label || 'Camera ' + device.deviceId }}
              </mat-option>
            </mat-select>
          </mat-form-field>
        </div>
      </div>
    </div>

    <!-- Results Section -->
    <div class="church-section">
      <div class="church-section-header">
        <h2 class="church-section-title">Live Attendance Results</h2>
      </div>
      <div class="church-section-content">
        <!-- Loading State -->
        <div *ngIf="isLoading" class="church-loading">
          <mat-spinner [diameter]="30"></mat-spinner>
          <p>Processing attendance...</p>
        </div>

        <!-- Empty State -->
        <div *ngIf="!isLoading && dataSource.data.length === 0" class="church-empty">
          <mat-icon class="church-empty-icon">qr_code_scanner</mat-icon>
          <p>Scan member barcodes to record attendance</p>
        </div>

        <!-- Attendance Table -->
        <div *ngIf="!isLoading && dataSource.data.length > 0" class="church-attendance-table">
          <table mat-table [dataSource]="dataSource" class="attendance-table">
            <!-- Barcode Column -->
            <ng-container matColumnDef="barcode">
              <th mat-header-cell *matHeaderCellDef>Barcode</th>
              <td mat-cell *matCellDef="let member">{{ member.barcode }}</td>
            </ng-container>
          
            <!-- First Name Column -->
            <ng-container matColumnDef="firstName">
              <th mat-header-cell *matHeaderCellDef>First Name</th>
              <td mat-cell *matCellDef="let member">{{ member.firstName }}</td>
            </ng-container>
          
            <!-- Last Name Column -->
            <ng-container matColumnDef="lastName">
              <th mat-header-cell *matHeaderCellDef>Last Name</th>
              <td mat-cell *matCellDef="let member">{{ member.lastName }}</td>
            </ng-container>
          
            <!-- Status Flag Column -->
            <ng-container matColumnDef="flag">
              <th mat-header-cell *matHeaderCellDef>Status</th>
              <td mat-cell *matCellDef="let member">
                <span class="attendance-flag" [ngClass]="member.flag.toLowerCase()">
                  {{ member.flag.toUpperCase() }}
                </span>
              </td>
            </ng-container>
          
            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>
